#!/usr/bin/env bash
set -e

APP_NAME="helpdesk-llm"

# Cluster names
AWS_CLUSTER="helpdesk-aws"
AZURE_CLUSTER="helpdesk-azure"

# Cloud settings
AWS_REGION="us-east-1"
AZURE_RG="helpdesk-rg"
AZURE_LOCATION="eastus"

MODE=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --mode)
      MODE="$2"
      shift 2
      ;;
    *)
      echo "Unknown argument: $1"
      exit 1
      ;;
  esac
done

if [[ -z "$MODE" ]]; then
  echo "Usage: $0 --mode [c|d]"
  echo "  c = create clusters + register with Argo"
  echo "  d = deploy Argo CD root app"
  exit 1
fi

# ---------------------------------------------------------
# MODE: c  (Create AWS + Azure clusters + register in Argo)
# ---------------------------------------------------------
if [[ "$MODE" == "c" ]]; then

  echo "=== Creating AWS EKS cluster using eksctl ==="
  eksctl create cluster \
    --name "$AWS_CLUSTER" \
    --region "$AWS_REGION" \
    --nodes 2 \
    --version 1.30

  echo "Updating kubeconfig for AWS..."
  aws eks update-kubeconfig \
    --name "$AWS_CLUSTER" \
    --region "$AWS_REGION"

  echo "AWS EKS cluster created."

  echo "=== Creating Azure AKS cluster ==="
  az group create --name "$AZURE_RG" --location "$AZURE_LOCATION"

  az aks create \
    --resource-group "$AZURE_RG" \
    --name "$AZURE_CLUSTER" \
    --node-count 2 \
    --node-vm-size Standard_B4ms \
    --generate-ssh-keys

  echo "Fetching kubeconfig for Azure..."
  az aks get-credentials \
    --resource-group "$AZURE_RG" \
    --name "$AZURE_CLUSTER" \
    --overwrite-existing

  echo "=== Registering clusters with Argo CD ==="

  # Detect kube contexts
  AWS_CTX=$(kubectl config get-contexts -o name | grep "$AWS_CLUSTER" | head -n 1)
  AZURE_CTX=$(kubectl config get-contexts -o name | grep "$AZURE_CLUSTER" | head -n 1)

  echo "AWS context: $AWS_CTX"
  echo "Azure context: $AZURE_CTX"

  if [[ -z "$AWS_CTX" || -z "$AZURE_CTX" ]]; then
    echo "ERROR: Could not detect kube contexts. Check kubeconfig."
    exit 1
  fi

  # Register with Argo CD
  argocd cluster add "$AWS_CTX" --name aws --yes
  argocd cluster add "$AZURE_CTX" --name azure --yes

  echo "Cluster creation + registration complete."
  exit 0
fi

# ---------------------------------------------------------
# MODE: d  (Deploy Argo CD root app)
# ---------------------------------------------------------
if [[ "$MODE" == "d" ]]; then
  echo "Applying Argo CD root application..."
  kubectl apply -f argo-apps/root-app.yaml
  echo "Argo CD will now sync AWS + Azure apps."
  exit 0
fi

echo "Invalid mode: $MODE"
exit 1
